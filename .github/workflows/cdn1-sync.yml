name: CDN1 同步 (ID 1-700)

on:
  schedule:
    # 每天北京时间中午12点运行 (UTC时间4点)
    - cron: '0 4 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  sync-cdn1:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出CDN1仓库
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: 配置Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: 克隆源仓库
        run: |
          echo "克隆源仓库..."
          git clone --depth 1 --filter=blob:none --sparse https://github.com/Sukiing-make-org/MYLAND66.github.io.git /tmp/source
          cd /tmp/source
          git sparse-checkout set pic/data
          echo "✅ 源仓库克隆完成"
      
      - name: 同步动漫数据 (ID 1-700)
        run: |
          echo "=========================================="
          echo "开始同步 CDN1 数据 (动漫ID 1-700)"
          echo "=========================================="
          
          SOURCE_DIR="/tmp/source/pic/data"
          HAS_UPDATES=false
          
          # 遍历ID 1-700
          for id in $(seq 1 700); do
            if [ -d "$SOURCE_DIR/$id" ]; then
              echo "📦 处理动漫ID: $id"
              
              # 检查源目录中是否有文件
              if [ "$(ls -A $SOURCE_DIR/$id 2>/dev/null)" ]; then
                # 创建目标目录
                mkdir -p "$id"
                
                # 使用rsync同步整个目录（保留结构，只更新变化的文件）
                rsync -av --delete "$SOURCE_DIR/$id/" "$id/"
                
                # 检查是否有变化
                if git status --porcelain | grep -q "^"; then
                  HAS_UPDATES=true
                  echo "  ✓ ID $id 已更新"
                else
                  echo "  → ID $id 无变化"
                fi
              else
                echo "  ✗ ID $id 目录为空，跳过"
              fi
            fi
          done
          
          echo "=========================================="
          
          # 如果有更新，提交变更
          if [ "$HAS_UPDATES" = true ]; then
            echo "检测到更新，准备提交..."
            git add .
            
            # 检查是否真的有变化需要提交
            if git diff --cached --quiet; then
              echo "ℹ️ 没有实际变化需要提交"
            else
              git commit -m "自动同步: 更新动漫数据 (ID 1-700) - $(date +'%Y-%m-%d %H:%M:%S')"
              git push
              echo "✅ 同步完成并已推送"
            fi
          else
            echo "ℹ️ 没有检测到更新"
          fi
      
      - name: 清理
        if: always()
        run: |
          rm -rf /tmp/source
          echo "✅ 临时文件已清理"
      
      - name: 同步结果
        if: always()
        run: |
          echo "=========================================="
          echo "CDN1 同步任务完成"
          echo "覆盖范围: 动漫ID 1-700"
          echo "执行时间: $(date +'%Y-%m-%d %H:%M:%S')"
          echo "=========================================="
