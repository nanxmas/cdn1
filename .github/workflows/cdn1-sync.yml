name: CDN1 同步 (ID 1-700)

on:
  schedule:
    # 每天北京时间中午12点运行 (UTC时间4点)
    - cron: '0 4 * * *'
  workflow_dispatch: # 允许手动触发

jobs:
  sync-cdn1:
    runs-on: ubuntu-latest
    
    steps:
      - name: 检出CDN1仓库
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: 配置Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: 同步动漫数据 (ID 1-700)
        run: |
          echo "开始同步 CDN1 数据 (动漫ID 1-700)..."
          
          # 源仓库URL
          SOURCE_REPO="https://raw.githubusercontent.com/Sukiing-make-org/MYLAND66.github.io/refs/heads/main"
          
          # 创建临时目录
          mkdir -p temp_download
          
          # 用于追踪是否有更新
          HAS_UPDATES=false
          
          # 遍历ID 1-700
          for id in $(seq 1 700); do
            echo "检查动漫ID: $id"
            
            # 检查远程是否存在该ID的JSON文件
            if curl --output /dev/null --silent --head --fail "$SOURCE_REPO/$id/$id.json"; then
              echo "发现动漫ID $id 存在于源仓库"
              
              # 创建目标目录
              mkdir -p "$id"
              
              # 下载JSON文件
              echo "下载 $id.json..."
              if curl -sL "$SOURCE_REPO/$id/$id.json" -o "temp_download/${id}.json"; then
                # 检查JSON是否有变化
                if [ ! -f "$id/$id.json" ] || ! cmp -s "temp_download/${id}.json" "$id/$id.json"; then
                  echo "JSON文件有更新，复制到目标目录"
                  cp "temp_download/${id}.json" "$id/$id.json"
                  HAS_UPDATES=true
                  
                  # 下载该ID目录下的所有图片
                  echo "检查并下载图片..."
                  
                  # 尝试下载常见的图片文件
                  for img in cover.jpg cover.png cover.webp 1.jpg 2.jpg 3.jpg 4.jpg 5.jpg 6.jpg 7.jpg 8.jpg 9.jpg 10.jpg; do
                    if curl --output /dev/null --silent --head --fail "$SOURCE_REPO/$id/$img"; then
                      echo "下载图片: $img"
                      curl -sL "$SOURCE_REPO/$id/$img" -o "$id/$img"
                    fi
                  done
                  
                  # 从JSON文件中解析图片列表（如果有的话）
                  if command -v jq &> /dev/null; then
                    # 尝试从JSON中提取图片列表
                    IMAGES=$(jq -r '.images[]? // empty' "$id/$id.json" 2>/dev/null || echo "")
                    if [ ! -z "$IMAGES" ]; then
                      echo "$IMAGES" | while read -r img_name; do
                        if [ ! -z "$img_name" ]; then
                          if curl --output /dev/null --silent --head --fail "$SOURCE_REPO/$id/$img_name"; then
                            echo "从JSON下载图片: $img_name"
                            curl -sL "$SOURCE_REPO/$id/$img_name" -o "$id/$img_name"
                          fi
                        fi
                      done
                    fi
                  fi
                else
                  echo "JSON文件无变化，跳过"
                fi
              else
                echo "下载 $id.json 失败"
              fi
            fi
          done
          
          # 清理临时文件
          rm -rf temp_download
          
          # 如果有更新，提交变更
          if [ "$HAS_UPDATES" = true ]; then
            echo "检测到更新，准备提交..."
            git add .
            git commit -m "自动同步: 更新动漫数据 (ID 1-700) - $(date +'%Y-%m-%d %H:%M:%S')"
            git push
            echo "✅ 同步完成并已推送"
          else
            echo "ℹ️ 没有检测到更新"
          fi
      
      - name: 同步结果
        if: always()
        run: |
          echo "CDN1 同步任务完成"
          echo "覆盖范围: 动漫ID 1-700"
          echo "执行时间: $(date +'%Y-%m-%d %H:%M:%S')"
